@page "/setupMonitor/{monitorId?}"
@attribute [Authorize(Roles = "monitor-editor")]

@inject MonitorService MonitorService
@inject NavigationManager NavigationManager
@inject BuildConfigService BuildConfigService; 
@using Cimon.Data.Monitors
@using System.Collections.Immutable
@using System.Text.Json
@using Cimon.Contracts.CI
@using Cimon.DB.Models
@using Cimon.Data.CIConnectors
@inherits ReactiveComponent

<PageTitle>Setup monitor @MonitorId</PageTitle>
<RadzenCard Visible="_monitor.HasValue">
    <RadzenButton Text="Save" Icon="save" Click="Save"/>
    <RadzenCard class="rz-mb-4 rz-mt-4">
        <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Title</RadzenText>
        <RadzenTextBox @bind-Value=@Monitor.Title class="w-100"/>
    </RadzenCard>
    <RadzenCard>
        <RadzenText TextStyle="TextStyle.Subtitle2" Text="Select builds to display"></RadzenText>
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End">
            <RadzenButton>
                <RadzenLink Path="/SetupCIConnectors">Setup connectors</RadzenLink>
            </RadzenButton>
        </RadzenStack>
        <RadzenDataGrid @ref="grid" AllowRowSelectOnRowClick="@true" Render="@OnRender"
                        AllowFiltering="true" FilterPopupRenderMode="PopupRenderMode.OnDemand"
                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                        AllowSorting="true" AllowColumnResize="true" AllowGrouping="true" AllGroupsExpanded="@true"
                        Data="@_buildConfigs.Value" TItem="BuildConfigModel" ColumnWidth="200px"
                        SelectionMode="DataGridSelectionMode.Multiple" @bind-Value=@_selectedLocators class="m-4">
            <Columns>
                <RadzenDataGridColumn TItem="BuildConfig" Width="60px" Sortable="false" Filterable="false">
                    <HeaderTemplate>
                        <RadzenCheckBox TriState="false" TValue="bool" Value="@(_buildConfigs.Value?.Any(i => _selectedLocators?.Contains(i) ?? false) ?? false)"
                                        Change="@(OnSelectAllChanged)"/>
                    </HeaderTemplate>
                    <Template Context="data">
                        <RadzenCheckBox TriState="false" Value="@(_selectedLocators.Contains(data))"
                                        TValue="bool"/>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="BuildConfig" Property="Id" Title="Id"/>
                <RadzenDataGridColumn TItem="BuildConfig" Property="CISystem" Title="CISystem"/>
                <RadzenDataGridColumn TItem="BuildConfig" Property="Key" Title="Key"/>
                <RadzenDataGridColumn TItem="BuildConfig" Property="Status" Title="Status"/>
                <RadzenDataGridColumn TItem="BuildConfig" Property="Branch" Title="Branch"/>
                <RadzenDataGridColumn TItem="BuildConfig" Property="IsDefaultBranch" Title="IsDefaultBranch" />
                <RadzenDataGridColumn TItem="BuildConfig" Title="Props">
                    <Template Context="item">
                        <RadzenText>@JsonSerializer.Serialize(item.Props)</RadzenText>
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
        </RadzenCard>
</RadzenCard>

@code {

    private ReactiveValue<MonitorModel> _monitor = null!;
    private MonitorModel Monitor => _monitor.Value;
    RadzenDataGrid<BuildConfigModel> grid;
    private ReactiveValue<IImmutableList<BuildConfigModel>> _buildConfigs;
    IList<BuildConfigModel> _selectedLocators = new List<BuildConfigModel>();
    
    [Parameter]
    public string? MonitorId { get; set; }

    void OnRender(DataGridRenderEventArgs<BuildConfigModel> args) {
        if (!args.FirstRender)
            return;
        args.Grid.Groups.Add(new GroupDescriptor {
            Property = nameof(BuildConfigModel.Connector),
            SortOrder = SortOrder.Ascending
        });
        StateHasChanged();
    }

    private void SetSelectedLocators(IList<BuildConfigModel>? list) {
        _selectedLocators = list ?? ArraySegment<BuildConfigModel>.Empty;
    }

    protected override async Task OnInitializedAsync() {
        await base.OnInitializedAsync();
        _buildConfigs = Subscribe(BuildConfigService.BuildConfigs);
        // todo combine build configs and monitor
        _monitor = Subscribe(MonitorService.GetMonitorById(MonitorId)).OnChange(monitor => {
            var descriptors = _buildConfigs.Value?.Where(l => monitor.Builds.Any(b => l.Equals(b.BuildConfig))).ToList();
            SetSelectedLocators(descriptors);
        });
    }

    private async Task Save() {
        await MonitorService.Save(Monitor, _selectedLocators);
        NavigationManager.NavigateTo("/monitorList");
    }

    private void OnSelectAllChanged(bool args) {
        SetSelectedLocators(args ? _buildConfigs.Value?.ToList() : null);
    }


}
