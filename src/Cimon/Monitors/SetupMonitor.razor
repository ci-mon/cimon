@page "/setupMonitor/{monitorId?}"
@attribute [Authorize(Roles = "monitor-editor")]

@inject MonitorService MonitorService
@inject IEnumerable<IBuildLocatorProvider> BuildLocatorProviders
@inject NavigationManager NavigationManager
@using Cimon.Data.Common
@using Cimon.Contracts
@using Cimon.Contracts.Services
@using Cimon.Data.BuildInformation
@inherits ReactiveComponent

<PageTitle>Setup monitor @MonitorId</PageTitle>
<RadzenCard Visible="_monitor.HasValue">
    <RadzenButton Text="Save" Icon="save" Click="Save"/>
    <RadzenCard class="rz-mb-4 rz-mt-4">
        <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">Title</RadzenText>
        <RadzenTextBox @bind-Value=@Monitor.Title class="w-100"/>
    </RadzenCard>
    <RadzenCard>
        <RadzenText TextStyle="TextStyle.Subtitle2" Text="Select builds to display"></RadzenText>
        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End">
            <RadzenButton Text="Refresh" Icon="refresh" Click="RefreshAvailableBuilds"></RadzenButton>
        </RadzenStack>
        <RadzenDataGrid @ref="grid" AllowRowSelectOnRowClick="@true" Render="@OnRender"
                        AllowFiltering="true" FilterPopupRenderMode="PopupRenderMode.OnDemand"
                        FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                        AllowSorting="true" AllowColumnResize="true" AllowGrouping="true" AllGroupsExpanded="@true"
                        Data="@_locators" TItem="BuildConfig" ColumnWidth="200px"
                        SelectionMode="DataGridSelectionMode.Multiple" @bind-Value=@_selectedLocators class="m-4">
            <Columns>
                <RadzenDataGridColumn TItem="BuildConfig" Width="60px" Sortable="false" Filterable="false">
                    <HeaderTemplate>
                        <RadzenCheckBox TriState="false" TValue="bool" Value="@(_locators?.Any(i => _selectedLocators?.Contains(i) ?? false) ?? false)"
                                        Change="@(OnSelectAllChanged)"/>
                    </HeaderTemplate>
                    <Template Context="data">
                        <RadzenCheckBox TriState="false" Value="@(_selectedLocators.Contains(data))"
                                        TValue="bool"/>
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="BuildConfig" Property="CiSystem" Title="CiSystem"/>
                <RadzenDataGridColumn TItem="BuildConfig" Property="Id" Title="Id"/>
            </Columns>
        </RadzenDataGrid>
        </RadzenCard>
</RadzenCard>

@code {

    private ReactiveValue<Monitor> _monitor = null!;
    private Monitor Monitor => _monitor.Value;
    RadzenDataGrid<BuildConfig> grid;
    IEnumerable<BuildConfig> _locators;
    IList<BuildConfig> _selectedLocators = new List<BuildConfig>();
    
    [Parameter]
    public string? MonitorId { get; set; }

    void OnRender(DataGridRenderEventArgs<BuildConfig> args) {
        if (!args.FirstRender)
            return;
        args.Grid.Groups.Add(new GroupDescriptor() {
            Property = nameof(BuildConfig.CiSystem),
            SortOrder = SortOrder.Ascending
        });
        StateHasChanged();
    }

    private void SetSelectedLocators(IList<BuildConfig>? list) {
        _selectedLocators = list ?? ArraySegment<BuildConfig>.Empty;
    }

    protected override async Task OnInitializedAsync() {
        await base.OnInitializedAsync();
        _locators = await BuildLocatorProviders.SelectMany(x => x.GetLocators()).ToListAsync();
        _monitor = Subscribe(MonitorService.GetMonitorById(MonitorId)).OnChange(monitor => {
            var descriptors = _locators.Where(l => monitor.Builds.Any(b => l.Id == b.Id)).ToList();
            SetSelectedLocators(descriptors);
        });
    }

    private async Task Save() {
        Monitor.Builds = _selectedLocators.OfType<BuildLocator>().ToList();
        await MonitorService.Save(Monitor);
        NavigationManager.NavigateTo("/monitorList");
    }

    private void OnSelectAllChanged(bool args) {
        SetSelectedLocators(args ? _locators?.ToList() : null);
    }

    private void RefreshAvailableBuilds() {
        throw new NotImplementedException();
    }

}
