@page "/mentions"
@using Cimon.Data.Discussions
@using Cimon.Data.Users
@using System.Collections.Immutable
@inherits ReactiveComponent
@inject ICurrentUserAccessor UserAccessor
@inject NavigationManager NavigationManager
<PageTitle>Mentions</PageTitle>
<RadzenCard>
    @if (_mentions is null) {
        <RadzenText TextStyle="TextStyle.H2" Text="Loading..." />
    } else if (_mentions.IsEmpty) {
        <RadzenText TextStyle="TextStyle.H2" Text="All good..." />
    } else {
        <RadzenStack Orientation="Orientation.Vertical" JustifyContent="JustifyContent.Start">
            <RadzenText Text="@StatusText" />
            @foreach (var mention in _mentions.Value) {
                <RadzenStack Orientation="Orientation.Horizontal">
                    <RadzenButton Text="@mention.DiscussionId" Click="() => GoToDiscussion(mention.DiscussionId)"/>
                </RadzenStack>
            }
        </RadzenStack>
    }
</RadzenCard>
@code {
    private ReactiveValue<IImmutableList<MentionInfo>?>? _mentions;
    private string StatusText => $"You was mentioned in {_mentions?.Value?.Count ?? 0} builds";
    protected override async Task InitializeReactiveValues() {
        await base.InitializeReactiveValues();
        var user = await UserAccessor.Current;
        _mentions = Subscribe(await AppActors.GetMentions(user))!;
    }

    private void GoToDiscussion(string discussionId) {
        NavigationManager.NavigateTo($"buildDiscussion/{discussionId}");
    }

}
